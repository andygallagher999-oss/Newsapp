<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
<style>
  body {font-family: Arial, sans-serif;margin:0;background:#f5f5f5;}
  header {text-align:center;padding:1rem;background:#2c3e50;color:white;font-size:1.6rem;font-weight:700;border-bottom:2px solid #e67e22;}
  .tab-bar,.category-bar {display:flex;flex-wrap:wrap;justify-content:center;background:#34495e;padding:0.5rem;}
  .tab-bar button,.category-bar button {margin:0.2rem;padding:0.5rem 0.8rem;border:none;border-radius:8px;background:#ecf0f1;cursor:pointer;font-weight:600;}
  .tab-bar button.active {background:#e67e22;color:white;}
  .category-bar button.active {background:#e74c3c;color:white;}
  #content {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;padding:1rem;}
  .card {background:white;border-radius:10px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;overflow:hidden;min-height:340px;}
  .card img {width:100%;border-radius:5px;margin-bottom:0.5rem;object-fit:cover;height:120px;}
  .placeholder-img {width:70%;max-height:90px;object-fit:contain;opacity:0.6;display:block;margin:0 auto 0.5rem;}
  .title {font-weight:bold;margin-bottom:0.5rem;}
  .source,.date,.read-time {font-size:0.8rem;color:#555;margin-bottom:0.3rem;}
  .summary {-webkit-line-clamp:3;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;}
  .actions {margin-top:auto;}
  #backToTop {position:fixed;bottom:20px;right:20px;background:#e67e22;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;display:none;}
  @media(max-width:768px){.card img{height:100px}.placeholder-img{max-height:60px}}
</style>
</head>
<body>
<header>Global Lens</header>
<input type="text" id="searchBar" placeholder="Search articles..." style="width:calc(100% - 2rem);margin:1rem;padding:0.5rem;">
<div class="tab-bar" id="sourceTabs"></div>
<div class="category-bar" id="categoryTabs"></div>
<div id="loading" style="text-align:center;padding:2rem;display:none;">Loading articles...</div>
<div id="content"></div>
<button id="backToTop">â†‘</button>

<script>
const CONFIG={
  RSS2JSON_API:'tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j',
  FINNHUB_API:'d32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg',
  PLACEHOLDER:'https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png'
};

// Sources and categories
const sources={
  'All':[],
  'Global':[
    {url:'https://globalnews.ca/feed/',category:'World'},
    {url:'https://globalnews.ca/entertainment/feed/',category:'Culture'},
    {url:'https://globalnews.ca/sports/feed/',category:'Sports'}
  ],
  'The Guardian':[
    {url:'https://www.theguardian.com/world/rss',category:'World'},
    {url:'https://www.theguardian.com/business/rss',category:'Business'},
    {url:'https://www.theguardian.com/science/rss',category:'Science'}
  ],
  'BBC':[
    {url:'https://feeds.bbci.co.uk/news/world/rss.xml',category:'World'},
    {url:'https://feeds.bbci.co.uk/news/technology/rss.xml',category:'Technology'},
    {url:'https://feeds.bbci.co.uk/news/business/rss.xml',category:'Business'}
  ],
  'NPR':[
    {url:'https://www.npr.org/rss/rss.php?id=1001',category:'World'},
    {url:'https://www.npr.org/rss/rss.php?id=1004',category:'Science'},
    {url:'https://www.npr.org/rss/rss.php?id=1019',category:'Business'},
    {url:'https://www.npr.org/rss/rss.php?id=1017',category:'Health'},
    {url:'https://www.npr.org/rss/rss.php?id=1128',category:'Culture'}
  ],
  'Billboard':[ {url:'https://www.billboard.com/feed/',category:'Culture'} ],
  'Crunch':[ {url:'https://techcrunch.com/feed/',category:'Technology'} ],
  'CNBC':[ {url:'https://www.cnbc.com/id/100003114/device/rss/rss.html',category:'Business'} ],
  'Markets':[]
};

const categories=['World','Business','Technology','Science','Health','Sports','Culture','Markets'];
let activeSource='All',activeCategory='',allArticles={},currentPage=1;
const perPage=12;

function debounce(f,t){let x;return(...a)=>{clearTimeout(x);x=setTimeout(()=>f(...a),t)}}

// Build tabs
const sourceTabs=document.getElementById('sourceTabs');
Object.keys(sources).forEach(s=>{
  const b=document.createElement('button');
  b.textContent=s;
  b.onclick=()=>{activeSource=s;activeCategory='';currentPage=1;render();if(s==='Markets')fetchMarkets();};
  if(s==='All')b.classList.add('active');
  sourceTabs.appendChild(b);
});
const categoryTabs=document.getElementById('categoryTabs');
categories.forEach(c=>{
  const b=document.createElement('button');
  b.textContent=c;
  b.onclick=()=>{activeCategory=activeCategory===c?'':c;currentPage=1;render();};
  categoryTabs.appendChild(b);
});

// Back-to-top
const topBtn=document.getElementById('backToTop');
window.addEventListener('scroll',debounce(()=>{topBtn.style.display=window.scrollY>300?'block':'none';},100));
topBtn.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});

// Search
document.getElementById('searchBar').addEventListener('input',e=>{currentPage=1;render(e.target.value.toLowerCase());});

// Fetch RSS
async function fetchRSS(feed){
  try{
    const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&api_key=${CONFIG.RSS2JSON_API}&count=30`);
    const d=await res.json();
    if(d.status!=='ok')return[];
    return d.items.map(i=>({...i,source:d.feed.title.replace(/https?:\/\/|www\.|\/.*/g,''),category:feed.category}));
  }catch(e){console.warn('Feed error',feed.url,e);return[];}
}

// Finnhub Markets
async function fetchMarkets(){
  if(allArticles.Markets?.length)return;
  const syms=[{s:'^GSPC',n:'S&P 500'},{s:'^DJI',n:'Dow Jones'},{s:'^IXIC',n:'Nasdaq'},{s:'^GSPTSE',n:'TSX'}];
  let html='<table><tr><th>Index</th><th>Price</th><th>Chg</th><th>%</th></tr>';
  for(const {s,n} of syms){
    try{
      const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(s)}&token=${CONFIG.FINNHUB_API}`);
      const d=await r.json();
      html+=`<tr><td>${n}</td><td>$${d.c||d.pc||'N/A'}</td><td>${d.d?.toFixed(2)||'N/A'}</td><td>${d.dp?.toFixed(2)||'N/A'}%</td></tr>`;
    }catch{html+=`<tr><td>${n}</td><td colspan="3">Data not available</td></tr>`;}
  }
  html+='</table>';
  allArticles.Markets=[{title:'Market Indices',description:html,link:'#',pubDate:new Date(),source:'Markets',category:'Markets',enclosure:{link:CONFIG.PLACEHOLDER}}];
}

// Load all feeds
async function loadFeeds(){
  document.getElementById('loading').style.display='block';
  for(const s in sources){
    if(s==='Markets')continue;
    allArticles[s]=[];
    for(const f of sources[s])allArticles[s].push(...await fetchRSS(f));
  }
  await fetchMarkets();
  document.getElementById('loading').style.display='none';
  render();
}

// Helpers
function getImg(a){
  if(a.enclosure?.link)return a.enclosure.link;
  if(a.thumbnail)return a.thumbnail;
  const d=document.createElement('div');d.innerHTML=DOMPurify.sanitize(a.description||'');
  const img=d.querySelector('img');return img?img.src:CONFIG.PLACEHOLDER;
}
function filterArticles(q=''){
  let arts=activeSource==='All'?Object.values(allArticles).flat():allArticles[activeSource]||[];
  if(activeCategory)arts=arts.filter(a=>a.category===activeCategory);
  if(q)arts=arts.filter(a=>a.title.toLowerCase().includes(q)||(a.description||'').toLowerCase().includes(q));
  return arts.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
}
function readTime(t){return Math.max(1,Math.ceil((t||'').split(/\s+/).length/200));}

// Render
function render(q=''){
  [...sourceTabs.children].forEach(b=>b.classList.toggle('active',b.textContent===activeSource));
  [...categoryTabs.children].forEach(b=>b.classList.toggle('active',b.textContent===activeCategory));
  const c=document.getElementById('content');c.innerHTML='';
  const a=filterArticles(q);
  if(!a.length){c.innerHTML='<div style="text-align:center;color:#777">No articles found.</div>';return;}
  const start=(currentPage-1)*perPage;
  a.slice(start,start+perPage).forEach(x=>{
    const card=document.createElement('div');card.className='card';
    const img=document.createElement('img');img.src=getImg(x);img.alt='image';img.onerror=()=>img.src=CONFIG.PLACEHOLDER;card.appendChild(img);
    card.innerHTML+=`<div class="title">${x.title}</div>
      <div class="source">${x.source||activeSource}</div>
      <div class="date">${new Intl.DateTimeFormat('en-CA',{dateStyle:'medium',timeStyle:'short',timeZone:'America/Toronto'}).format(new Date(x.pubDate))}</div>
      <div class="read-time">${readTime(x.description)} min read</div>
      <div class="summary">${DOMPurify.sanitize(x.description||'')}</div>
      <div class="actions"><a href="${x.link}" target="_blank" style="color:#e67e22;text-decoration:none">Read full article</a></div>`;
    c.appendChild(card);
  });
  if(a.length>start+perPage){
    const b=document.createElement('button');
    b.textContent='Load More';
    b.style.cssText='margin:1rem auto;display:block;padding:0.5rem 1rem;background:#e67e22;color:white;border:none;border-radius:5px;';
    b.onclick=()=>{currentPage++;render(q);};
    c.appendChild(b);
  }
}

// Start
loadFeeds();
</script>
</body>
</html>
