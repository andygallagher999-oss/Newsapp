<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
  header { text-align: center; padding: 1rem; background: #1a1a1a; color: white; font-size: 1.5rem; font-weight: bold; }
  .tabs { display: flex; flex-wrap: wrap; justify-content: center; background: #222; }
  .tab { padding: 0.7rem 1rem; margin: 0.2rem; color: white; cursor: pointer; border-radius: 8px; background: #444; }
  .tab.active { background: #f90; color: #000; font-weight: bold; }
  .category-bar { display: flex; flex-wrap: wrap; justify-content: center; margin: 0.5rem 0; }
  .category { padding: 0.5rem 0.8rem; margin: 0.2rem; background: #ddd; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
  .category.active { background: #f90; color: #000; font-weight: bold; }
  .content { display: flex; flex-wrap: wrap; justify-content: center; margin: 1rem; }
  .card { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); margin: 0.5rem; padding: 1rem; max-width: 320px; flex: 1 1 300px; display: flex; flex-direction: column; }
  .market-card { background: #e3f2fd; max-width: 200px; flex: 1 1 180px; text-align: center; margin: 0.5rem; padding: 0.7rem; }
  .card img { width: 100%; border-radius: 8px; margin-bottom: 0.5rem; }
  .card h3 { margin: 0.3rem 0; font-size: 1rem; }
  .card p { font-size: 0.85rem; color: #333; }
  .badge { display: inline-block; font-size: 0.7rem; margin: 0.2rem 0.2rem 0 0; padding: 0.2rem 0.4rem; background: #f0f0f0; border-radius: 4px; }
  .source-badge { background: #1a1a1a; color: #fff; }
  @media(max-width:768px){
    .content { flex-direction: column; align-items: center; }
    .card { max-width: 90%; }
  }
</style>
</head>
<body>

<header>Global Lens</header>

<!-- Main Tabs -->
<div class="tabs" id="tabs">
  <div class="tab active" data-feed="all">All</div>
  <div class="tab" data-feed="guardian">The Guardian</div>
  <div class="tab" data-feed="billboard">Billboard</div>
  <div class="tab" data-feed="npr">NPR</div>
  <div class="tab" data-feed="crunch">TechCrunch</div>
  <div class="tab" data-feed="bbc">BBC</div>
  <div class="tab" data-feed="cnbc">CNBC</div>
  <div class="tab" data-feed="bloomberg">Bloomberg</div>
  <div class="tab" data-feed="markets">Markets</div>
</div>

<!-- Category Buttons -->
<div class="category-bar" id="categories">
  <div class="category active" data-category="all">All</div>
  <div class="category" data-category="world">World</div>
  <div class="category" data-category="business">Business</div>
  <div class="category" data-category="technology">Technology</div>
  <div class="category" data-category="science">Science</div>
  <div class="category" data-category="health">Health</div>
  <div class="category" data-category="culture">Culture</div>
  <div class="category" data-category="sports">Sports</div>
</div>

<!-- Content Area -->
<div class="content" id="content"></div>

<script>
const rssApiKey = "tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j";
const finnhubKey = "d32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg";

const feeds = {
  bbc: "http://feeds.bbci.co.uk/news/world/rss.xml",
  guardian: "https://www.theguardian.com/world/rss",
  npr: "https://www.npr.org/rss/rss.php?id=1019",
  billboard: "https://www.billboard.com/feed/",
  crunch: "https://feeds.feedburner.com/TechCrunch/",
  cnbc: "https://www.cnbc.com/id/100003114/device/rss/rss.html",
  bloomberg: "https://feeds.bloomberg.com/markets/news.rss"
};

// Track loaded articles per feed
let loadedCounts = {};
const pageSize = 12;

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    loadFeed(tab.dataset.feed, document.querySelector('.category.active').dataset.category);
  });
});

// Categories
document.querySelectorAll('.category').forEach(cat => {
  cat.addEventListener('click', () => {
    document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
    cat.classList.add('active');
    const activeTab = document.querySelector('.tab.active').dataset.feed;
    loadFeed(activeTab, cat.dataset.category);
  });
});

async function fetchRSS(feedUrl) {
  try {
    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&api_key=${rssApiKey}&count=50`);
    const data = await res.json();
    return data.items || [];
  } catch (e) {
    console.error("Failed RSS", feedUrl, e);
    return [];
  }
}

// Market data
async function fetchMarkets() {
  const symbols = ["^GSPC","^DJI","^IXIC","^TSX"];
  const cards = [];
  for (const s of symbols){
    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${finnhubKey}`);
      const data = await res.json();
      cards.push({symbol: s, price: data.c, change: data.d, changePct: data.dp});
    } catch(e){
      console.error("Failed Market", s, e);
    }
  }
  return cards;
}

// Main feed loader
async function loadFeed(feedName, category="all"){
  const container = document.getElementById('content');
  container.innerHTML = "<p>Fetching...</p>";

  if(feedName === "markets"){
    container.innerHTML = "";
    const markets = await fetchMarkets();
    markets.forEach(m => {
      const card = document.createElement('div');
      card.className = 'market-card';
      card.innerHTML = `<div><strong>${m.symbol}</strong></div>
                        <div>Price: ${m.price}</div>
                        <div>Change: ${m.change.toFixed(2)} (${m.changePct.toFixed(2)}%)</div>`;
      container.appendChild(card);
    });
    return;
  }

  container.innerHTML = "";
  loadedCounts[feedName] = loadedCounts[feedName] || 0;
  let items = [];

  if(feedName === "all"){
    const allItems = [];
    for(const f in feeds){
      const feedItems = await fetchRSS(feeds[f]);
      feedItems.forEach(item => item.source=f);
      allItems.push(...feedItems);
    }
    items = allItems.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
  } else {
    items = await fetchRSS(feeds[feedName]);
    items.forEach(item => item.source=feedName);
  }

  if(category !== "all"){
    items = items.filter(i => i.categories && i.categories.includes(category));
  }

  const displayItems = items.slice(0, pageSize);
  loadedCounts[feedName] += pageSize;

  displayItems.forEach(i => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      ${i.enclosure && i.enclosure.link ? `<img src="${i.enclosure.link}" alt="image"/>` : ""}
      <h3>${i.title}</h3>
      <div class="badge source-badge">${i.source}</div>
      ${i.categories ? i.categories.map(c=>`<div class="badge">${c}</div>`).join('') : ""}
      <p>${i.description ? i.description.substring(0,200)+"..." : ""}</p>
      <a href="${i.link}" target="_blank">Read More</a>
    `;
    container.appendChild(card);
  });
}

// Initial load
loadFeed("all");

// Infinite scroll
window.addEventListener('scroll', async ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 10){
    const activeTab = document.querySelector('.tab.active').dataset.feed;
    const activeCat = document.querySelector('.category.active').dataset.category;
    await loadFeed(activeTab, activeCat);
  }
});
</script>

</body>
</html>
