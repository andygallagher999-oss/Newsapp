<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
body {font-family:Arial, sans-serif;margin:0;padding:0;background:#f5f5f5;}
header {text-align:center;padding:1rem;background:#2c3e50;color:white;font-size:1.5rem;}
.tab-bar {display:flex;flex-wrap:wrap;justify-content:center;background:#34495e;padding:0.5rem;}
.tab-bar button {margin:0.2rem;padding:0.5rem 1rem;border:none;border-radius:5px;background:#ecf0f1;cursor:pointer;}
.tab-bar button.active {background:#e67e22;color:white;}
.category-bar {display:flex;flex-wrap:wrap;justify-content:center;padding:0.5rem;background:#bdc3c7;}
.category-bar button {margin:0.2rem;padding:0.3rem 0.7rem;border:none;border-radius:5px;background:#ecf0f1;cursor:pointer;}
.category-bar button.active {background:#e74c3c;color:white;}
#content {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;padding:1rem;justify-content:flex-start;}
.card {background:white;border-radius:10px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;height:360px;overflow:hidden;position:relative;}
.card img {width:100%;border-radius:5px;margin-bottom:0.5rem;object-fit:cover;height:160px;}
.card .title {font-weight:bold;margin-bottom:0.5rem;}
.card .source {font-size:0.8rem;color:#7f8c8d;margin-bottom:0.5rem;}
.card .date {font-size:0.8rem;color:#999;margin-bottom:0.5rem;}
.card .summary {margin-bottom:0.5rem;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;}
.card.expanded .summary {-webkit-line-clamp:unset;}
.card .actions {display:flex;justify-content:space-between;align-items:center;margin-top:auto;}
.card button.read-more {background:none;border:none;color:#e67e22;cursor:pointer;}
#backToTop {position:fixed;bottom:20px;right:20px;background:#e67e22;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;display:none;}
@media(max-width:768px){#content{grid-template-columns:1fr;}}
@media(min-width:769px) and (max-width:1024px){#content{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<header>Global Lens</header>
<div class="tab-bar" id="sourceTabs"></div>
<div class="category-bar" id="categoryTabs"></div>
<div id="content"></div>
<button id="backToTop">↑</button>

<script>
const RSS2JSON_API = 'tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j';
const FINNHUB_API = 'd32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg';

// Sources including 5 NPR feeds
const sources = {
  'All': [],
  'The Guardian': ['https://www.theguardian.com/world/rss'],
  'BBC': [],
  'NPR': [
    'https://www.npr.org/rss/rss.php?id=1001', // Top Stories
    'https://www.npr.org/rss/rss.php?id=1004', // World
    'https://www.npr.org/rss/rss.php?id=1019', // Business
    'https://www.npr.org/rss/rss.php?id=1017', // Technology
    'https://www.npr.org/rss/rss.php?id=1128'  // Health
  ],
  'Billboard': ['https://www.billboard.com/feed/'],
  'Crunch': ['https://techcrunch.com/feed/'],
  'CNBC': ['https://www.cnbc.com/id/100003114/device/rss/rss.html'],
  'Bloomberg': ['https://feeds.bloomberg.com/markets/news.rss'],
  'Markets': []
};

const categories = ['World','Business','Technology','Science','Health','Sports','Culture'];
let activeSource='All';
let activeCategory='';
let allArticles={};

// Build tabs
const sourceTabs=document.getElementById('sourceTabs');
for(const s in sources){
  const btn=document.createElement('button');
  btn.textContent=s;
  btn.onclick=()=>{activeSource=s;activeCategory='';render();fetchMarketsIfNeeded();};
  if(s==='All') btn.classList.add('active');
  sourceTabs.appendChild(btn);
}
const categoryTabs=document.getElementById('categoryTabs');
categories.forEach(cat=>{
  const btn=document.createElement('button');
  btn.textContent=cat;
  btn.onclick=()=>{activeCategory=activeCategory===cat?'':cat;render();};
  categoryTabs.appendChild(btn);
});

const backToTop=document.getElementById('backToTop');
backToTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
window.onscroll=()=>{backToTop.style.display=window.scrollY>300?'block':'none';};

// Fetch RSS
async function fetchRSS(url){
  try{
    const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${RSS2JSON_API}&count=30`);
    const data=await res.json();
    return data.items.map(i=>({...i,source:data.feed.title}));
  }catch(e){console.error('RSS Error',url,e);return [];}
}

// Fetch Markets: indices card + news
async function fetchMarketsIfNeeded(){
  if(activeSource!=='Markets') return;
  if(allArticles.Markets && allArticles.Markets.length) return;

  let cards=[];

  // 1️⃣ Indices card first
  const symbols=["^GSPC","^DJI","^IXIC","^TSX"];
  let indicesHTML='';
  for(const s of symbols){
    try{
      const r=await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${s}`);
      const d=await r.json();
      const q=d.quoteResponse.result[0];
      if(q){
        const price = q.regularMarketPrice ?? q.previousClose;
        const change = q.regularMarketChange ?? (price - q.previousClose);
        const pct = q.regularMarketChangePercent ?? (q.previousClose ? ((price - q.previousClose)/q.previousClose)*100 : 0);
        indicesHTML += `${q.shortName||s}: ${price} (${change.toFixed(2)}, ${pct.toFixed(2)}%)<br>`;
      } else {
        indicesHTML += `${s}: Market data not available<br>`;
      }
    }catch(e){
      indicesHTML += `${s}: Market data not available<br>`;
    }
  }

  // First card: Indices
  cards.push({
    title:'Market Indices',
    link:'#',
    pubDate:Date.now(),
    description:indicesHTML,
    enclosure:{link:'https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png'},
    source:'Markets'
  });

  // 2️⃣ Fetch Finnhub general market news
  try {
    const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_API}`);
    const data = await res.json();
    data.forEach(d=>{
      cards.push({
        title:d.headline,
        link:d.url,
        pubDate:d.datetime*1000,
        description:d.summary,
        enclosure:{link:d.image || 'https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png'},
        source:'Finnhub'
      });
    });
  } catch(e){ console.error('Finnhub news error', e); }

  allArticles.Markets = cards;
  render();
}

// Fetch all other feeds
async function fetchAll(){
  for(const src in sources){
    allArticles[src]=[];
    for(const feed of sources[src]){
      const items=await fetchRSS(feed);
      allArticles[src]=allArticles[src].concat(items);
    }
    // Ensure NPR Top Stories first
    if(src==='NPR'){
      allArticles[src].sort((a,b)=>{
        if(a.source.includes('Top Stories')) return -1;
        if(b.source.includes('Top Stories')) return 1;
        return new Date(b.pubDate)-new Date(a.pubDate);
      });
    }
  }
}

// Filter articles by category
function filterArticles(){
  let articles=activeSource==='All'?Object.values(allArticles).flat():allArticles[activeSource]||[];
  if(activeCategory){
    articles=articles.filter(a=>{
      const text=(a.title+' '+(a.description||'')).toLowerCase();
      return text.includes(activeCategory.toLowerCase());
    });
  }
  return articles.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
}

// Render cards
function render(){
  Array.from(sourceTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeSource));
  Array.from(categoryTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeCategory));
  const container=document.getElementById('content');
  container.innerHTML='';
  const articles=filterArticles();

  const placeholders=Math.max(0,4-articles.length);
  articles.forEach(a=>addCard(container,a));
  for(let i=0;i<placeholders;i++){
    addCard(container,{
      title:'',
      link:'#',
      pubDate:'',
      description:'',
      enclosure:{link:'https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png'},
      source:''
    },true);
  }
}

// Add single card
function addCard(container,a,isPlaceholder=false){
  const card=document.createElement('div');
  card.className='card';
  const img=document.createElement('img');
  const validImg=(a.enclosure && a.enclosure.link && a.enclosure.link.trim()!=='')
    ? a.enclosure.link
    : 'https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png';
  img.src=validImg;
  img.onerror=()=>{img.src='https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png';};
  card.appendChild(img);

  if(!isPlaceholder){
    const title=document.createElement('div');
    title.className='title';
    title.textContent=a.title;
    card.appendChild(title);

    const srcDiv=document.createElement('div');
    srcDiv.className='source';
    srcDiv.textContent=a.source||activeSource;
    card.appendChild(srcDiv);

    const dateDiv=document.createElement('div');
    dateDiv.className='date';
    dateDiv.textContent=a.pubDate ? new Date(a.pubDate).toLocaleString() : '';
    card.appendChild(dateDiv);

    const summary=document.createElement('div');
    summary.className='summary';
    summary.innerHTML=a.description||'';
    card.appendChild(summary);

    const actions=document.createElement('div');
    actions.className='actions';
    if(a.link && a.link!=='#'){
      const link=document.createElement('a');
      link.href=a.link;
      link.target='_blank';
      link.textContent='Read full article';
      actions.appendChild(link);
    }

    if(summary.scrollHeight>summary.clientHeight){
      const btn=document.createElement('button');
      btn.textContent='Read More';
      btn.className='read-more';
      btn.onclick=()=>{
        card.classList.toggle('expanded');
        btn.textContent=card.classList.contains('expanded')?'Read Less':'Read More';
      };
      actions.appendChild(btn);
    }
    card.appendChild(actions);
  }
  container.appendChild(card);
}

// Initialize
(async()=>{
  await fetchAll();
  await fetchMarketsIfNeeded();
  render();
})();
</script>
</body>
</html>
