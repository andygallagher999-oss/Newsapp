<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
  body {font-family: Arial, sans-serif; margin:0; background:#f5f5f5;}
  header {background:#222; color:#fff; padding:10px; text-align:center; font-size:1.4em;}
  #categoryTabs {display:flex; overflow-x:auto; background:#333;}
  #categoryTabs button {
    flex:1; padding:10px; border:none; background:#333; color:#fff;
    font-size:1em; cursor:pointer; white-space:nowrap;
  }
  #categoryTabs button.active {background:#555;}
  #content {padding:10px; max-width:900px; margin:auto;}
  .card {
    display:flex; background:#fff; margin-bottom:10px; border-radius:6px;
    overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,.1);
  }
  .card img {
    width:100px; height:100px; object-fit:cover; flex-shrink:0;
  }
  .info {padding:10px; flex:1; display:flex; flex-direction:column;}
  .title {
    font-weight:bold; margin-bottom:5px; cursor:pointer;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .source {color:#666; font-size:0.85em;}
  .date {color:#999; font-size:0.8em; margin-bottom:6px;}
  #loadingSpinner {text-align:center; padding:15px; display:none; color:#555;}
  #backToTop {
    position:fixed; bottom:20px; right:20px; display:none;
    background:#333; color:#fff; border:none; padding:10px; border-radius:50%;
    cursor:pointer;
  }
</style>
</head>
<body>
<header>Global Lens</header>

<div id="categoryTabs"></div>
<div id="content"></div>
<div id="loadingSpinner">Loading…</div>
<button id="backToTop">↑</button>

<script>
const API_KEY = "mfvxyevwnjlcnuwmiyprrivbbpyylyhwwzuezdaq"; // ← your live key
const BATCH_SIZE = 8;
const PLACEHOLDER = "logo.png";

const categories = {
  "Sports": [
    "https://www.sportsnet.ca/feed/",
    "http://feeds.bbci.co.uk/sport/rss.xml"
  ],
  "Business": [
    "https://www.reuters.com/business/rss",
    "https://www.marketwatch.com/rss/topstories"
  ],
  "News": [
    "https://www.cbc.ca/cmlink/rss-topstories",
    "https://globalnews.ca/feed/",
    "https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009"
  ],
  "Entertainment": [
    "https://globalnews.ca/entertainment/feed/",
    "https://www.ctvnews.ca/entertainment/rss/ctvnews-ca-entertainment-public-rss-1.822289",
    "https://www.hollywoodreporter.com/t/rss"
  ]
};

let activeCategory = "Sports";

// State: { [cat]: {items:[], shown:n} }
const allArticles = {};

const categoryTabs = document.getElementById("categoryTabs");
const contentDiv   = document.getElementById("content");
const spinner      = document.getElementById("loadingSpinner");
const backToTopBtn = document.getElementById("backToTop");

// --- Build category buttons ---
Object.keys(categories).forEach(cat=>{
  const btn=document.createElement("button");
  btn.textContent=cat;
  btn.onclick=()=>{setActiveCategory(cat)};
  if(cat===activeCategory) btn.classList.add("active");
  categoryTabs.appendChild(btn);
});

// Back-to-top
backToTopBtn.onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
window.addEventListener("scroll",()=>{
  backToTopBtn.style.display=window.scrollY>300?"block":"none";
  checkInfiniteScroll();
});

// --- Helpers ---
function toET(dateStr){
  const d = new Date(dateStr);
  return new Date(d.getTime() - 4*60*60*1000);
}

function extractImage(item){
  if(item.enclosure && item.enclosure.link) return item.enclosure.link;
  if(item.thumbnail) return item.thumbnail;
  if(item.content && /<img/i.test(item.content)){
    const tmp = document.createElement("div");
    tmp.innerHTML = item.content;
    const img = tmp.querySelector("img");
    if(img && img.src) return img.src;
  }
  if(item.description && /<img/i.test(item.description)){
    const tmp = document.createElement("div");
    tmp.innerHTML = item.description;
    const img = tmp.querySelector("img");
    if(img && img.src) return img.src;
  }
  return null;
}

// --- Data fetching ---
async function fetchFeed(url){
  const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${API_KEY}&count=20`;
  try {
    const res = await fetch(apiUrl);
    const data = await res.json();
    if(data.status!=="ok") return [];
    return data.items.map(i => ({...i, source:data.feed.title}));
  } catch(e){
    console.error("Fetch error", url, e);
    return [];
  }
}

async function loadCategory(cat){
  spinner.style.display="block";
  allArticles[cat] = {items:[], shown:0};
  const feeds = categories[cat];
  let combined = [];
  for(const f of feeds){
    const items = await fetchFeed(f);
    combined = combined.concat(items);
  }
  // Remove duplicates & filter items with no image
  const seen = new Set();
  allArticles[cat].items = combined.filter(a=>{
    const img = extractImage(a);
    if(!img || seen.has(a.link)) return false;
    a.imgUrl = img;
    seen.add(a.link);
    return true;
  }).sort((a,b)=> new Date(b.pubDate)-new Date(a.pubDate));
  spinner.style.display="none";
  renderBatch(cat);
}

// --- Rendering ---
function renderBatch(cat){
  const state = allArticles[cat];
  const next = state.items.slice(state.shown, state.shown + BATCH_SIZE);
  state.shown += next.length;
  next.forEach(a=>{
    const card=document.createElement("div");
    card.className="card";

    const img=document.createElement("img");
    img.src=a.imgUrl || PLACEHOLDER;
    card.appendChild(img);

    const info=document.createElement("div");
    info.className="info";

    const title=document.createElement("div");
    title.className="title";
    title.textContent=a.title;
    title.onclick=()=>window.open(a.link,"_blank");
    info.appendChild(title);

    const src=document.createElement("div");
    src.className="source";
    src.textContent=a.source;
    info.appendChild(src);

    const date=document.createElement("div");
    date.className="date";
    date.textContent=toET(a.pubDate).toLocaleString();
    info.appendChild(date);

    card.appendChild(info);
    contentDiv.appendChild(card);
  });
}

// --- Infinite Scroll ---
function checkInfiniteScroll(){
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 200){
    const state = allArticles[activeCategory];
    if(state && state.shown < state.items.length){
      renderBatch(activeCategory);
    }
  }
}

// --- Category switching ---
async function setActiveCategory(cat){
  activeCategory = cat;
  contentDiv.innerHTML="";
  Array.from(categoryTabs.children).forEach(btn=>{
    btn.classList.toggle("active", btn.textContent===cat);
  });
  if(!allArticles[cat]) await loadCategory(cat);
  else renderBatch(cat);
}

// --- Init ---
(async ()=>{
  await loadCategory(activeCategory);
})();
</script>
</body>
</html>
