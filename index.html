<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
}
header {
    text-align: center;
    padding: 1rem;
    background: #2c3e50;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.tab-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background: #34495e;
    padding: 0.5rem;
}
.tab-bar button {
    margin: 0.3rem;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    background: #ecf0f1;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.tab-bar button:hover {
    background: #e67e22;
    color: white;
    transform: translateY(-2px);
}
.tab-bar button.active {
    background: #e67e22;
    color: white;
}
.category-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0.5rem;
    background: #bdc3c7;
}
.category-bar button {
    margin: 0.2rem;
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 6px;
    background: #ecf0f1;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.category-bar button:hover {
    background: #e74c3c;
    color: white;
    transform: translateY(-1px);
}
.category-bar button.active {
    background: #e74c3c;
    color: white;
}
#content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    padding: 1rem;
    justify-content: flex-start;
}
.card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    height: auto;
    overflow: hidden;
    position: relative;
}
.card img {
    width: 100%;
    border-radius: 5px;
    margin-bottom: 0.5rem;
    object-fit: cover;
    height: 200px; /* increased for mobile */
}
.card .title {
    font-weight: bold;
    margin-bottom: 0.5rem;
    font-size: 1.1rem; /* larger on mobile */
}
.card .source {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-bottom: 0.5rem;
}
.card .date {
    font-size: 0.85rem;
    color: #999;
    margin-bottom: 0.5rem;
}
.card .summary {
    margin-bottom: 0.5rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    font-size: 0.95rem; /* larger for mobile */
}
.card.expanded .summary {
    -webkit-line-clamp: unset;
}
.card .actions {
    display: flex;
    justify-content: flex-start;
    margin-top: auto;
}
.card .actions a {
    text-decoration: none;
    background: #e67e22;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 5px;
    font-weight: bold;
    transition: all 0.3s ease;
}
.card .actions a:hover {
    background: #d35400;
}
#backToTop {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #e67e22;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
}
.card .summary table {
    width: 100%;
    border-collapse: collapse;
    display: block;
    max-height: 120px;
    overflow: auto;
}
.card .summary table th,
.card .summary table td {
    border: 1px solid #ccc;
    padding: 4px;
    text-align: center;
    font-size: 0.85rem;
}
.card .summary table th {
    background: #f0f0f0;
}
@media(max-width:768px){
    header {font-size: 1.8rem;padding: 1rem;}
    .tab-bar button {padding: 0.8rem 1.6rem; font-size: 1.05rem; border-radius:10px;}
    .category-bar button {padding: 0.7rem 1.2rem; font-size: 1rem; border-radius:8px;}
    .card img{height:220px;}
    .card .title{font-size:1.2rem;}
    .card .summary{-webkit-line-clamp:5;font-size:1rem;}
    .card .actions a{padding:0.5rem 1rem;font-size:1rem;}
    .card .summary table{max-height:180px;}
}
</style>
</head>
<body>
<header>Global Lens</header>
<div class="tab-bar" id="sourceTabs"></div>
<div class="category-bar" id="categoryTabs"></div>
<div id="content"></div>
<button id="backToTop">â†‘</button>

<script>
const RSS2JSON_API='tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j';
const FINNHUB_API='d32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg';
const PLACEHOLDER_LOGO='https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png';

const sources={
  'All': [],
  'Global': [
    'https://globalnews.ca/feed/',
    'https://globalnews.ca/entertainment/feed/',
    'https://globalnews.ca/sports/feed/'
  ],
  'The Guardian': ['https://www.theguardian.com/world/rss'],
  'BBC': [
    'http://feeds.bbci.co.uk/news/world/rss.xml',
    'http://feeds.bbci.co.uk/news/business/rss.xml',
    'http://feeds.bbci.co.uk/news/technology/rss.xml'
  ],
  'NPR': [
    'https://www.npr.org/rss/rss.php?id=1001',
    'https://www.npr.org/rss/rss.php?id=1004',
    'https://www.npr.org/rss/rss.php?id=1019',
    'https://www.npr.org/rss/rss.php?id=1017',
    'https://www.npr.org/rss/rss.php?id=1128'
  ],
  'Billboard': ['https://www.billboard.com/feed/'],
  'Crunch': ['https://techcrunch.com/feed/'],
  'CNBC': ['https://www.cnbc.com/id/100003114/device/rss/rss.html'],
  'Markets': []
};

const categories=['World','Business','Technology','Science','Health','Sports','Culture'];
let activeSource='All';
let activeCategory='';
let allArticles={};

// Build tabs
const sourceTabs=document.getElementById('sourceTabs');
for(const s in sources){
  const btn=document.createElement('button');
  btn.textContent=s;
  btn.onclick=()=>{activeSource=s;activeCategory='';render();fetchMarketsIfNeeded();};
  if(s==='All') btn.classList.add('active');
  sourceTabs.appendChild(btn);
}

const categoryTabs=document.getElementById('categoryTabs');
categories.forEach(cat=>{
  const btn=document.createElement('button');
  btn.textContent=cat;
  btn.onclick=()=>{activeCategory=activeCategory===cat?'':cat;render();};
  categoryTabs.appendChild(btn);
});

const backToTop=document.getElementById('backToTop');
backToTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
window.onscroll=()=>{backToTop.style.display=window.scrollY>300?'block':'none';};

async function fetchRSS(url){
  try{
    const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${RSS2JSON_API}&count=30`);
    const data=await res.json();
    return data.items.map(i=>{
      if(i.link.includes('entertainment')) i.category=['Culture'];
      else if(i.link.includes('sports')) i.category=['Sports'];
      else i.category=i.category||[];
      return {...i,source:data.feed.title};
    });
  }catch(e){console.error('RSS Error',url,e);return [];}
}

function getArticleImage(a){
  let imgUrl=PLACEHOLDER_LOGO;
  if(a.enclosure && a.enclosure.link) imgUrl=a.enclosure.link;
  else if(a.thumbnail) imgUrl=a.thumbnail;
  else{
    const tempDiv=document.createElement('div');
    tempDiv.innerHTML=a.description||a.content||'';
    const imgTag=tempDiv.querySelector('img');
    if(imgTag) imgUrl=imgTag.src;
  }
  return imgUrl;
}

// Fetch Markets and always place first
async function fetchMarketsIfNeeded(){
  if(allArticles.Markets && allArticles.Markets.length) return;

  let cards=[];
  const symbols=[
    {s:'^GSPC',name:'S&P 500'},
    {s:'^DJI',name:'Dow Jones'},
    {s:'^IXIC',name:'Nasdaq'},
    {s:'^GSPTSE',name:'TSX'}
  ];

  let tableHTML='<table><tr><th>Index</th><th>Price</th><th>Change</th><th>%Change</th></tr>';
  for(const sym of symbols){
    try{
      const res=await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(sym.s)}&token=${FINNHUB_API}`);
      const data=await res.json();
      const price=(data.c||data.pc||'N/A');
      const change=(data.d!==undefined?data.d.toFixed(2):'N/A');
      const pct=(data.dp!==undefined?data.dp.toFixed(2):'N/A');
      tableHTML+=`<tr><td>${sym.name}</td><td>${price}</td><td>${change}</td><td>${pct}</td></tr>`;
    }catch(e){
      tableHTML+=`<tr><td>${sym.name}</td><td colspan="3">Market data not available</td></tr>`;
    }
  }
  tableHTML+='</table>';

  cards.push({
    title:'Market Indices',
    link:'#',
    pubDate:Date.now(),
    description:tableHTML,
    enclosure:{link:PLACEHOLDER_LOGO},
    source:'Markets'
  });

  try{
    const res=await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_API}`);
    const data=await res.json();
    data.forEach(d=>{
      cards.push({
        title:d.headline,
        link:d.url,
        pubDate:d.datetime*1000,
        description:d.summary,
        enclosure:{link:d.image||PLACEHOLDER_LOGO},
        source:'Finnhub'
      });
    });
  }catch(e){console.error('Finnhub news error',e);}

  allArticles.Markets=cards;
}

// Fetch all feeds
async function fetchAll(){
  for(const src in sources){
    allArticles[src]=[];
    for(const feed of sources[src]){
      const items=await fetchRSS(feed);
      allArticles[src]=allArticles[src].concat(items);
    }
  }
  await fetchMarketsIfNeeded();
}

function filterArticles(){
  let articles=activeSource==='All'?Object.values(allArticles).flat():allArticles[activeSource]||[];
  if(activeCategory){
    articles=articles.filter(a=>{
      const text=(a.title+' '+(a.description||'')).toLowerCase();
      const categoryMatch=(a.category||[]).some(c=>c.toLowerCase()===activeCategory.toLowerCase());
      return text.includes(activeCategory.toLowerCase()) || categoryMatch;
    });
  }
  return articles.sort((a,b)=>new Date(a.pubDate)-0 - (new Date(b.pubDate)-0)).reverse();
}

function render(){
  Array.from(sourceTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeSource));
  Array.from(categoryTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeCategory));

  const container=document.getElementById('content');
  container.innerHTML='';
  let articles=filterArticles();

  // Ensure Markets card is first if present
  if(activeSource==='Markets'){
    const marketCardIndex=articles.findIndex(a=>a.source==='Markets');
    if(marketCardIndex>0){
      const [marketCard]=articles.splice(marketCardIndex,1);
      articles.unshift(marketCard);
    }
  }

  let totalCards=articles.length;
  const columns=4;
  const remainder=totalCards%columns;
  const placeholderCards=remainder?columns-remainder:0;

  articles.forEach(a=>{
    const card=document.createElement('div');
    card.className='card';
    const img=document.createElement('img');
    img.src=getArticleImage(a);
    img.onerror=()=>{img.src=PLACEHOLDER_LOGO;};
    card.appendChild(img);

    const title=document.createElement('div');
    title.className='title';
    title.textContent=a.title;
    card.appendChild(title);

    const srcDiv=document.createElement('div');
    srcDiv.className='source';
    srcDiv.textContent=a.source.includes('globalnews')?'Global':a.source;
    card.appendChild(srcDiv);

    const dateDiv=document.createElement('div');
    dateDiv.className='date';
    dateDiv.textContent=new Date(a.pubDate).toLocaleString(undefined,{timeZoneName:'short'});
    card.appendChild(dateDiv);

    const summary=document.createElement('div');
    summary.className='summary';
    summary.innerHTML=a.description||'';
    card.appendChild(summary);

    const actions=document.createElement('div');
    actions.className='actions';
    const link=document.createElement('a');
    link.href=a.link;
    link.target='_blank';
    link.textContent='Read full article';
    actions.appendChild(link);
    card.appendChild(actions);

    container.appendChild(card);
  });

  for(let i=0;i<placeholderCards;i++){
    const card=document.createElement('div');
    card.className='card';
    const img=document.createElement('img');
    img.src=PLACEHOLDER_LOGO;
    card.appendChild(img);
    const title=document.createElement('div');
    title.className='title';
    title.textContent='Global Lens';
    card.appendChild(title);
    container.appendChild(card);
  }
}

(async()=>{await fetchAll();render();})();
</script>
</body>
</html>
