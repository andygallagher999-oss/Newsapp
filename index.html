<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<link rel="apple-touch-icon" href="logo.png">
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { display:flex; align-items:center; justify-content:center; padding:1rem; background:#2c3e50; color:white; font-size:1.5rem; }
header img.header-logo { height:40px; margin-right:0.6rem; }

.category-bar { display:flex; flex-wrap:wrap; justify-content:center; background:#bdc3c7; padding:0.5rem; }
.category-bar button { margin:0.2rem; padding:0.6rem 1.2rem; border:none; border-radius:6px; background:#ecf0f1; cursor:pointer; font-size:1rem; flex:1 0 auto; }
.category-bar button.active { background:#e74c3c; color:white; }
.category-bar button:hover { background:#d0d3d4; }

#content { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; padding:1rem; }
.card { background:white; border-radius:10px; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; height:auto; overflow:hidden; }
.card img { width:100%; border-radius:5px; margin-bottom:0.5rem; object-fit:cover; height:120px; }
.card .title { font-weight:bold; margin-bottom:0.5rem; cursor:pointer; color:#2c3e50; text-decoration:underline; }
.card .source { font-size:0.8rem; color:#7f8c8d; margin-bottom:0.2rem; }
.card .date { font-size:0.8rem; color:#999; margin-bottom:0.5rem; }
.card .summary { margin-bottom:0.5rem; overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; }
#backToTop { position:fixed; bottom:20px; right:20px; background:#e67e22; color:white; border:none; border-radius:50%; width:50px; height:50px; font-size:1.5rem; cursor:pointer; display:none; }

/* MOBILE LAYOUT */
@media(max-width:768px){
  #content { display:block; }
  .card { display:flex; flex-direction:row; height:auto; }
  .card img { width:100px; height:100px; margin-right:0.5rem; margin-bottom:0; }
  .card .text { flex:1; display:flex; flex-direction:column; }
  .card .title { -webkit-line-clamp:2; }
  .card .summary { -webkit-line-clamp:3; }
  .card .actions { display:none; }
}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Global Lens Logo" class="header-logo"> Global Lens
</header>

<div class="category-bar" id="categoryTabs"></div>
<div id="content"></div>
<button id="backToTop">â†‘</button>

<script>
const RSS2JSON_API = 'mfvxyevwnjlcnuwmiyprrivbbpyylyhwwzuezdaq';
const PLACEHOLDER_LOGO = 'logo.png';
const PAGE_SIZE = 20;

// --- CATEGORY FEEDS (verified, paywall-free, image-rich) ---
const categories = {
  "Sports":[
    "https://www.sportsnet.ca/feed/",
    "https://feeds.bbci.co.uk/sport/rss.xml?edition=uk",
    "https://www.cbssports.com/rss/headlines"
  ],
  "Business":[
    "https://www.reuters.com/business/rss",
    "https://www.cnbc.com/id/10001147/device/rss/rss.html",
    "https://www.forbes.com/business/feed2/"
  ],
  "News":[
    "https://www.cbc.ca/cmlink/rss-topstories",
    "https://globalnews.ca/feed/",
    "https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009",
    "https://www.theglobeandmail.com/canada/feed/"
  ],
  "Entertainment":[
    "https://globalnews.ca/entertainment/feed/",
    "https://www.ctvnews.ca/entertainment/rss/ctvnews-ca-entertainment-public-rss-1.822289",
    "https://www.etcanada.com/feed/"
  ]
};

// --- STATE ---
let activeCategory = "Sports";
const allArticles = {};
const feedIndex = {}; // track per feed per category
const categoryTabs = document.getElementById('categoryTabs');
const contentDiv = document.getElementById('content');

// --- CATEGORY BUTTONS ---
Object.keys(categories).forEach(cat=>{
  const btn=document.createElement('button');
  btn.textContent=cat;
  btn.onclick=()=>{activeCategory=cat; render(true);};
  if(cat===activeCategory) btn.classList.add('active');
  categoryTabs.appendChild(btn);
});

// --- SCROLL TO TOP ---
const backToTop = document.getElementById('backToTop');
backToTop.onclick = ()=>window.scrollTo({top:0,behavior:'smooth'});
window.onscroll = ()=>{ backToTop.style.display = window.scrollY>300?'block':'none'; };

// --- IMAGE DETECTION ---
function getArticleImage(item){
  if(item.enclosure && item.enclosure.link) return item.enclosure.link;
  if(item.thumbnail) return item.thumbnail;
  if(item["media:content"] && item["media:content"].url) return item["media:content"].url;
  if(item["media:thumbnail"] && item["media:thumbnail"].url) return item["media:thumbnail"].url;
  const tmp = document.createElement('div');
  tmp.innerHTML = item.content || item.description || '';
  const imgTag = tmp.querySelector('img');
  if(imgTag && imgTag.src) return imgTag.src;
  return null;
}

// --- FETCH RSS ---
async function fetchRSS(url){
  const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${RSS2JSON_API}&count=${PAGE_SIZE}`;
  try{
    const res = await fetch(api);
    const data = await res.json();
    if(data.status !== "ok") return [];
    return data.items.map(i=>({...i,source:data.feed.title,image:getArticleImage(i)}))
                    .filter(i=>i.image !== null);
  }catch(e){console.error("RSS Error:",url,e); return []; }
}

// --- LOAD ALL FEEDS FOR CATEGORY ---
async function loadCategory(category){
  if(!feedIndex[category]) feedIndex[category] = 0;
  if(feedIndex[category] >= categories[category].length) return; // all feeds loaded

  const feedsToLoad = categories[category].slice(feedIndex[category]);
  const promises = feedsToLoad.map(feed => fetchRSS(feed));
  const results = await Promise.all(promises);

  allArticles[category] = allArticles[category] ? allArticles[category].concat(...results) : [].concat(...results);
  feedIndex[category] = categories[category].length; // mark all feeds loaded
}

// --- RENDER ---
async function render(reset=false){
  if(reset){
    contentDiv.innerHTML='';
    allArticles[activeCategory]=[];
    feedIndex[activeCategory]=0;
  }

  await loadCategory(activeCategory);
  allArticles[activeCategory].sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));

  Array.from(categoryTabs.children).forEach(btn=>btn.classList.toggle('active', btn.textContent===activeCategory));
  contentDiv.innerHTML='';

  allArticles[activeCategory].forEach(a=>{
    const card=document.createElement('div'); card.className='card';
    const img=document.createElement('img'); img.src=a.image || PLACEHOLDER_LOGO; card.appendChild(img);
    const textDiv=document.createElement('div'); textDiv.className='text';
    const title=document.createElement('div'); title.className='title'; title.textContent=a.title; title.onclick=()=>window.open(a.link,'_blank'); textDiv.appendChild(title);
    const summary=document.createElement('div'); summary.className='summary'; summary.innerHTML=(a.description||'').replace(/<img[^>]*>/gi,''); textDiv.appendChild(summary);
    const srcDiv=document.createElement('div'); srcDiv.className='source'; srcDiv.textContent=a.source; textDiv.appendChild(srcDiv);
    const dateDiv=document.createElement('div'); dateDiv.className='date'; dateDiv.textContent=new Date(a.pubDate).toLocaleString(); textDiv.appendChild(dateDiv);
    card.appendChild(textDiv);
    contentDiv.appendChild(card);
  });
}

// --- INFINITE SCROLL ---
window.addEventListener('scroll', async ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 300){
    if(feedIndex[activeCategory] < categories[activeCategory].length){
      await loadCategory(activeCategory);
      render();
    }
  }
});

// --- INIT ---
render();
</script>
</body>
</html>
