<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
body {font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
header {text-align:center;padding:1rem;background:#2c3e50;color:white;font-size:1.8rem;font-weight:bold;}
.tab-bar, .category-bar {display:flex;flex-wrap:wrap;justify-content:center;padding:0.5rem;}
.tab-bar {background:#34495e;}
.tab-bar button {margin:0.2rem;padding:0.5rem 1rem;border:none;border-radius:5px;background:#ecf0f1;cursor:pointer;font-weight:bold;}
.tab-bar button.active {background:#e67e22;color:white;}
.category-bar {background:#bdc3c7;}
.category-bar button {margin:0.2rem;padding:0.3rem 0.7rem;border:none;border-radius:5px;background:#ecf0f1;cursor:pointer;font-weight:bold;}
.category-bar button.active {background:#e74c3c;color:white;}
#content {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;padding:1rem;justify-content:flex-start;}
.card {background:white;border-radius:10px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;height:360px;overflow:hidden;position:relative;}
.card img {width:100%;border-radius:5px;margin-bottom:0.5rem;object-fit:cover;height:120px;}
.card .title {font-weight:bold;margin-bottom:0.5rem;}
.card .source {font-size:0.8rem;color:#7f8c8d;margin-bottom:0.5rem;}
.card .date {font-size:0.8rem;color:#999;margin-bottom:0.5rem;}
.card .summary {margin-bottom:0.5rem;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;}
.card.expanded .summary {-webkit-line-clamp:unset;}
.card .actions {display:flex;justify-content:space-between;align-items:center;margin-top:auto;}
.card button.read-more {background:none;border:none;color:#e67e22;cursor:pointer;}
#backToTop {position:fixed;bottom:20px;right:20px;background:#e67e22;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;display:none;}
.card .summary table {width:100%;border-collapse:collapse;display:block;max-height:120px;overflow:auto;}
.card .summary table th, .card .summary table td {border:1px solid #ccc;padding:4px;text-align:center;font-size:0.85rem;}
.card .summary table th {background:#f0f0f0;}
@media(max-width:768px){.card img{height:100px;}.card .summary table{max-height:150px;}}
</style>
</head>
<body>
<header>Global Lens</header>
<div class="tab-bar" id="sourceTabs"></div>
<div class="category-bar" id="categoryTabs"></div>
<div id="content"></div>
<button id="backToTop">â†‘</button>

<script>
const RSS2JSON_API='tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j';
const PLACEHOLDER_LOGO='https://raw.githubusercontent.com/andygallagher999-oss/Newsapp/main/assets/images/global-lens-logo.png';

// Feeds
const sources = {
  'All': [],
  'Global': [
    'https://globalnews.ca/feed/',
    'https://globalnews.ca/entertainment/feed/',
    'https://globalnews.ca/sports/feed/'
  ],
  'BBC': [
    'https://feeds.bbci.co.uk/news/world/rss.xml',
    'https://feeds.bbci.co.uk/news/business/rss.xml',
    'https://feeds.bbci.co.uk/news/technology/rss.xml'
  ],
  'The Guardian': ['https://www.theguardian.com/world/rss'],
  'NPR': [
    'https://www.npr.org/rss/rss.php?id=1001',
    'https://www.npr.org/rss/rss.php?id=1004',
    'https://www.npr.org/rss/rss.php?id=1019'
  ],
  'Billboard': ['https://www.billboard.com/feed/'],
  'Crunch': ['https://techcrunch.com/feed/'],
  'CNBC': ['https://www.cnbc.com/id/100003114/device/rss/rss.html'],
  'Markets': []
};

const categories = ['World','Business','Technology','Science','Health','Sports','Culture'];
let activeSource='All';
let activeCategory='';
let allArticles={};

// Build source tabs (no icons)
const sourceTabs=document.getElementById('sourceTabs');
for(const s in sources){
  const btn=document.createElement('button');
  btn.textContent=s;
  btn.onclick=()=>{activeSource=s;activeCategory='';render();};
  if(s==='All') btn.classList.add('active');
  sourceTabs.appendChild(btn);
}

// Build category tabs (keep icons optional if you want later)
const categoryTabs=document.getElementById('categoryTabs');
categories.forEach(cat=>{
  const btn=document.createElement('button');
  btn.textContent=cat;
  btn.onclick=()=>{activeCategory=activeCategory===cat?'':cat;render();};
  categoryTabs.appendChild(btn);
});

const backToTop=document.getElementById('backToTop');
backToTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
window.onscroll=()=>{backToTop.style.display=window.scrollY>300?'block':'none';};

// Helper to fetch RSS via rss2json
async function fetchRSS(url){
  try{
    const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${RSS2JSON_API}&count=30`);
    const data=await res.json();
    return data.items.map(i=>({...i,source:data.feed.title}));
  }catch(e){console.error('RSS Error',url,e);return [];}
}

// Get image
function getArticleImage(a){
  let imgUrl = PLACEHOLDER_LOGO;
  if(a.enclosure && a.enclosure.link) imgUrl = a.enclosure.link;
  else if(a.thumbnail) imgUrl = a.thumbnail;
  else if(a['media:thumbnail'] && a['media:thumbnail'].url) imgUrl = a['media:thumbnail'].url;
  else if(a.content) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = a.content || a.description || '';
    const imgTag = tempDiv.querySelector('img');
    if(imgTag) imgUrl = imgTag.src;
  }
  return imgUrl;
}

// Fetch all articles
async function fetchAll(){
  for(const src in sources){
    allArticles[src]=[];
    for(const feed of sources[src]){
      const items=await fetchRSS(feed);
      allArticles[src]=allArticles[src].concat(items.map(a=>{
        // Map Global Entertainment to Culture category
        if(src==='Global' && feed.includes('entertainment')) a.category='Culture';
        // Map Global Sports to Sports category
        if(src==='Global' && feed.includes('sports')) a.category='Sports';
        return a;
      }));
    }
  }
}

// Filter articles by source/category
function filterArticles(){
  let articles=activeSource==='All'?Object.values(allArticles).flat():allArticles[activeSource]||[];
  if(activeCategory){
    articles=articles.filter(a=>{
      // Check category first, else search title/description
      if(a.category) return a.category.toLowerCase()===activeCategory.toLowerCase();
      const text=(a.title+' '+(a.description||'')).toLowerCase();
      return text.includes(activeCategory.toLowerCase());
    });
  }
  return articles.sort((a,b)=>new Date(a.pubDate)-0 - (new Date(b.pubDate)-0)).reverse();
}

// Render articles
function render(){
  Array.from(sourceTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeSource));
  Array.from(categoryTabs.children).forEach(btn=>btn.classList.toggle('active',btn.textContent===activeCategory));

  const container=document.getElementById('content');
  container.innerHTML='';
  let articles=filterArticles();

  articles.forEach(a=>{
    const card=document.createElement('div');
    card.className='card';
    const img=document.createElement('img');
    img.src=getArticleImage(a);
    img.onerror=()=>{img.src=PLACEHOLDER_LOGO;};
    card.appendChild(img);

    const title=document.createElement('div');
    title.className='title';
    title.textContent=a.title;
    card.appendChild(title);

    const srcDiv=document.createElement('div');
    srcDiv.className='source';
    // Simplify source name
    if(a.source.includes('Global News')) srcDiv.textContent='Global';
    else srcDiv.textContent=a.source||activeSource;
    card.appendChild(srcDiv);

    const dateDiv=document.createElement('div');
    dateDiv.className='date';
    const d=new Date(a.pubDate);
    dateDiv.textContent=d.toLocaleString('en-CA',{timeZone:'America/Toronto'});
    card.appendChild(dateDiv);

    const summary=document.createElement('div');
    summary.className='summary';
    summary.innerHTML=a.description||'';
    card.appendChild(summary);

    const actions=document.createElement('div');
    actions.className='actions';
    const link=document.createElement('a');
    link.href=a.link;
    link.target='_blank';
    link.textContent='Read full article';
    actions.appendChild(link);
    card.appendChild(actions);

    container.appendChild(card);
  });
}

// Initialize
(async()=>{await fetchAll();render();})();
</script>
</body>
</html>
