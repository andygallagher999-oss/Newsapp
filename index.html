<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
  header { text-align: center; padding: 1rem; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  header h1 { margin: 0; font-size: 1.5rem; }
  #buttons { display: flex; flex-wrap: wrap; justify-content: center; background: #eee; padding: 0.5rem; }
  #buttons button { margin: 0.25rem; padding: 0.5rem 1rem; border: none; border-radius: 6px; background: #0077cc; color: #fff; cursor: pointer; }
  #buttons button.active { background: #005fa3; }
  #content { padding: 1rem; }
  .feed-heading { margin: 1rem 0 0.5rem; font-weight: bold; color: #333; font-size: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 0.25rem; }
  .card { background: #fff; padding: 1rem; margin: 0.5rem 0; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .card .source { font-size: 0.8rem; color: #555; margin-bottom: 0.25rem; }
  .card .title { font-weight: bold; margin-bottom: 0.25rem; }
  .card .snippet { font-size: 0.9rem; color: #333; }
  .market-card { background: #e0f0ff; padding: 0.75rem; margin: 0.5rem 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9rem; }
  .market-card .name { font-weight: bold; margin-bottom: 0.25rem; }
  #loading { text-align: center; margin: 1rem; color: #777; }
</style>
</head>
<body>
<header>
  <h1>Global Lens</h1>
</header>

<div id="buttons">
  <button data-tab="all" class="active">All</button>
  <button data-tab="bbc">BBC</button>
  <button data-tab="guardian">Guardian</button>
  <button data-tab="tech">TechCrunch</button>
  <button data-tab="other">Other</button>
  <button data-tab="markets">Markets</button>
</div>

<div id="content"></div>
<div id="loading">Fetching...</div>

<script>
const API_KEY = "tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j";
const FEEDS = {
  bbc: [
    { name: "BBC World", url: "http://feeds.bbci.co.uk/news/world/rss.xml" },
    { name: "BBC Business", url: "http://feeds.bbci.co.uk/news/business/rss.xml" }
  ],
  guardian: [
    { name: "Guardian World", url: "https://www.theguardian.com/world/rss" },
    { name: "Guardian Business", url: "https://www.theguardian.com/business/rss" }
  ],
  tech: [
    { name: "TechCrunch", url: "https://feeds.feedburner.com/TechCrunch/" }
  ],
  other: [
    { name: "NPR", url: "https://www.npr.org/rss/rss.php?id=1019" },
    { name: "Billboard", url: "https://www.billboard.com/feed/" }
  ]
};

const MARKETS = [
  { name: "S&P 500", symbol: "^GSPC" },
  { name: "Dow Jones", symbol: "^DJI" },
  { name: "Nasdaq", symbol: "^IXIC" },
  { name: "TSX", symbol: "^TSX" }
];

let currentTab = "all";
let storyData = {};
let displayedCount = {};

function createCard(story) {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <div class="source">${story.source}</div>
    <div class="title">${story.title}</div>
    <div class="snippet">${story.description}</div>
  `;
  return card;
}

function createMarketCard(market) {
  const card = document.createElement("div");
  card.className = "market-card";
  card.innerHTML = `
    <div class="name">${market.name}</div>
    <div>Price: ${market.price}</div>
    <div>Change: ${market.change} (${market.percent}%)</div>
  `;
  return card;
}

async function fetchRSS(feedUrl, sourceName) {
  try {
    const res = await fetch(`https://api.rssrjson.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&api_key=${API_KEY}&count=20`);
    const data = await res.json();
    return data.items.map(item => ({
      title: item.title,
      description: item.description || item.content || "",
      source: sourceName,
      pubDate: new Date(item.pubDate)
    }));
  } catch (e) {
    console.error("Failed RSS", feedUrl, e);
    return [];
  }
}

async function loadStories() {
  document.getElementById("loading").style.display = "block";
  storyData = {};
  displayedCount = {};
  
  for (let tab in FEEDS) {
    storyData[tab] = [];
    displayedCount[tab] = 0;
    for (let feed of FEEDS[tab]) {
      const stories = await fetchRSS(feed.url, feed.name);
      storyData[tab].push(...stories);
    }
    // Sort by most recent first
    storyData[tab].sort((a,b) => b.pubDate - a.pubDate);
  }

  // For All tab, combine all stories
  storyData["all"] = [];
  for (let tab in FEEDS) storyData["all"].push(...storyData[tab]);
  storyData["all"].sort((a,b) => b.pubDate - a.pubDate);
  
  displayedCount["all"] = 0;
  displayedCount["bbc"] = 0;
  displayedCount["guardian"] = 0;
  displayedCount["tech"] = 0;
  displayedCount["other"] = 0;
  
  renderTab(currentTab);
  document.getElementById("loading").style.display = "none";
}

function renderTab(tab) {
  currentTab = tab;
  const container = document.getElementById("content");
  container.innerHTML = "";
  const stories = storyData[tab] || [];
  
  const loadMoreCount = 12;
  const toDisplay = stories.slice(displayedCount[tab], displayedCount[tab] + loadMoreCount);
  displayedCount[tab] += toDisplay.length;

  // For All tab, group by feed source
  if(tab === "all") {
    const grouped = {};
    toDisplay.forEach(story => {
      if(!grouped[story.source]) grouped[story.source] = [];
      grouped[story.source].push(story);
    });
    for(let source in grouped){
      const heading = document.createElement("div");
      heading.className = "feed-heading";
      heading.textContent = source;
      container.appendChild(heading);
      grouped[source].forEach(story => container.appendChild(createCard(story)));
    }
  } else if(tab === "markets") {
    loadMarkets(container);
  } else {
    toDisplay.forEach(story => container.appendChild(createCard(story)));
  }
}

async function loadMarkets(container) {
  container.innerHTML = "";
  for(let m of MARKETS){
    try{
      const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${m.symbol}`);
      const data = await res.json();
      const q = data.quoteResponse.result[0];
      container.appendChild(createMarketCard({
        name: m.name,
        price: q.regularMarketPrice,
        change: q.regularMarketChange.toFixed(2),
        percent: q.regularMarketChangePercent.toFixed(2)
      }));
    } catch(e){
      console.error("Market fetch failed", m, e);
    }
  }
}

document.getElementById("buttons").addEventListener("click", e => {
  if(e.target.tagName === "BUTTON"){
    document.querySelectorAll("#buttons button").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    renderTab(e.target.dataset.tab);
  }
});

// Infinite scroll / load more on scroll
window.addEventListener("scroll", () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
    if(currentTab !== "markets"){
      const stories = storyData[currentTab];
      if(displayedCount[currentTab] < stories.length){
        renderTab(currentTab);
      }
    }
  }
});

loadStories();
</script>
</body>
</html>
