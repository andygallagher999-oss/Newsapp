<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { text-align:center; padding:1rem; background:#222; color:white; font-size:1.5rem; }
  #market-container { display:flex; flex-wrap:wrap; justify-content:center; margin:1rem; }
  .market-card { background:#fff; padding:.5rem; margin:.5rem; width:120px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.15); text-align:center; font-size:.9rem; }
  .news-container { display:flex; flex-wrap:wrap; justify-content:center; margin:1rem; }
  .news-card { background:white; width:300px; margin:.5rem; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; }
  .news-card img { width:100%; height:150px; object-fit:cover; }
  .news-content { padding:.8rem; flex-grow:1; display:flex; flex-direction:column; }
  .news-title { font-weight:bold; margin-bottom:.3rem; font-size:1rem; }
  .news-desc { font-size:.85rem; margin-bottom:.5rem; display:none; }
  .news-source { font-size:.75rem; color:#555; margin-top:auto; }
  .button-group { display:flex; flex-wrap:wrap; justify-content:center; margin:.5rem 0; }
  button { margin:.3rem; padding:.5rem 1rem; border:none; border-radius:6px; background:#007BFF; color:white; cursor:pointer; font-size:.85rem; }
  button.active { background:#0056b3; }
  hr { border:0; border-top:1px solid #ccc; margin:1rem 0; }
</style>
</head>
<body>
<header>Global Lens</header>

<!-- Market Cards -->
<div id="market-container"></div>

<!-- Source Buttons -->
<div class="button-group" id="source-buttons"></div>

<hr>

<!-- Category Buttons -->
<div class="button-group" id="category-buttons"></div>

<!-- News Container -->
<div class="news-container" id="news-container"></div>

<script>
const rssrApiKey = "tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j";
const finnhubKey = "d32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg";

// Feeds
const sources = {
  "The Guardian":"https://www.theguardian.com/world/rss",
  "Billboard":"https://www.billboard.com/feed/",
  "NPR":"https://www.npr.org/rss/rss.php?id=1019",
  "Crunch":"https://feeds.feedburner.com/TechCrunch/",
  "BBC":"http://feeds.bbci.co.uk/news/world/rss.xml",
  "CNBC":"https://www.cnbc.com/id/100003114/device/rss/rss.html",
  "Bloomberg":"https://feeds.bloomberg.com/markets/news"
};

const categories = ["World","Sports","Technology","Business","Culture","Science/Health"];
let allArticles = {};
let activeSource = "All";
let activeCategory = "All";
let perLoad = 12;

// Helper to fetch RSS
async function fetchRSS(url){
  try {
    const res = await fetch(`https://api.rssrjson.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${rssrApiKey}&count=50`);
    const data = await res.json();
    return data.items || [];
  } catch(e){
    console.error("Failed RSS", url, e);
    return [];
  }
}

// Load all feeds
async function loadAllFeeds(){
  const keys = Object.keys(sources);
  for(const key of keys){
    const items = await fetchRSS(sources[key]);
    allArticles[key] = items.map(i => ({title:i.title, link:i.link, description:i.description, source:key, image:i.thumbnail||i.image||""}));
  }
  displayArticles();
}

// Display buttons
function displayButtons(){
  const sourceDiv = document.getElementById("source-buttons");
  sourceDiv.innerHTML = "";
  const allBtn = document.createElement("button"); allBtn.textContent="All"; allBtn.classList.add("active");
  allBtn.onclick = () => {activeSource="All"; setActiveButton(sourceDiv,allBtn); displayArticles();};
  sourceDiv.appendChild(allBtn);
  Object.keys(sources).forEach(src=>{
    const btn = document.createElement("button"); btn.textContent=src;
    btn.onclick = ()=>{activeSource=src; setActiveButton(sourceDiv,btn); displayArticles();};
    sourceDiv.appendChild(btn);
  });

  const catDiv = document.getElementById("category-buttons");
  catDiv.innerHTML="";
  categories.forEach(cat=>{
    const btn = document.createElement("button"); btn.textContent=cat;
    btn.onclick = ()=>{activeCategory=cat; setActiveButton(catDiv,btn); displayArticles();};
    catDiv.appendChild(btn);
  });
}

function setActiveButton(container,btn){
  Array.from(container.children).forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

// Display news cards
function displayArticles(){
  const container = document.getElementById("news-container");
  container.innerHTML="";
  let articles=[];
  if(activeSource==="All"){
    articles = [].concat(...Object.values(allArticles));
  } else {
    articles = allArticles[activeSource] || [];
  }
  // Optional: filter by category if desired
  articles = articles.slice(0,perLoad);
  articles.forEach(a=>{
    const card = document.createElement("div"); card.className="news-card";
    card.innerHTML = `
      ${a.image?`<img src="${a.image}" />`:''}
      <div class="news-content">
        <div class="news-title">${a.title}</div>
        <div class="news-desc">${a.description||""}</div>
        <div class="news-source">${a.source}</div>
      </div>`;
    // Expand on click
    card.onclick = ()=>{
      const desc = card.querySelector(".news-desc");
      if(desc.style.display==="none" || desc.style.display===""){desc.style.display="block";}
      else{desc.style.display="none";}
    };
    container.appendChild(card);
  });
}

// Load market data
async function loadMarkets(){
  const symbols = ["^GSPC","^DJI","^IXIC","^TSX"];
  const container = document.getElementById("market-container");
  for(const s of symbols){
    try{
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${finnhubKey}`);
      const data = await res.json();
      const card = document.createElement("div"); card.className="market-card";
      card.innerHTML=`<div>${s}</div>
                      <div>Price: ${data.c}</div>
                      <div>Change: ${data.d} (${data.dp}%)</div>`;
      container.appendChild(card);
    }catch(e){console.error("Market fetch failed",s,e);}
  }
}

// Initialize
displayButtons();
loadAllFeeds();
loadMarkets();
</script>
</body>
</html>
