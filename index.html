<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0;}
  h1 { text-align:center; padding:1rem; }
  #tabs { display:flex; justify-content:center; flex-wrap:wrap; margin-bottom:1rem; }
  .tab-btn { padding:0.5rem 1rem; margin:0.2rem; border:none; border-radius:8px; background:#0077cc; color:white; cursor:pointer;}
  .tab-btn.active { background:#005fa3; }
  #content { max-width:600px; margin:0 auto; padding:0 1rem; }
  .card { background:white; margin:0.5rem 0; padding:0.8rem; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.1);}
  .market-card { background:#e0f0ff; font-weight:bold; }
  .feed-heading { margin-top:1rem; font-weight:bold; font-size:1.1rem; border-bottom:1px solid #ccc; padding-bottom:0.2rem; }
  .source-badge { font-size:0.8rem; color:#555; margin-left:0.5rem; }
  #loading { text-align:center; padding:1rem; display:none; }
</style>
</head>
<body>
<h1>Global Lens</h1>
<div id="tabs">
  <button class="tab-btn active" data-tab="all">All</button>
  <button class="tab-btn" data-tab="news">News</button>
  <button class="tab-btn" data-tab="culture">Culture</button>
  <button class="tab-btn" data-tab="markets">Markets</button>
</div>
<div id="content"></div>
<div id="loading">Fetching...</div>

<script>
const API_KEY = "tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j";

// Define RSS feeds
const FEEDS = {
  news: [
    {name:"BBC World", url:"http://feeds.bbci.co.uk/news/world/rss.xml"},
    {name:"The Guardian World", url:"https://www.theguardian.com/world/rss"}
  ],
  culture: [
    {name:"Billboard", url:"https://www.billboard.com/feed/"},
    {name:"NPR Culture", url:"https://www.npr.org/rss/rss.php?id=1019"}
  ],
  markets: [
    {name:"CNBC Top News", url:"https://www.cnbc.com/id/100003114/device/rss/rss.html"},
    {name:"Bloomberg Markets", url:"https://feeds.bloomberg.com/markets/news.rss"}
  ]
};

let storyData = {};
let displayedCount = {};
let currentTab = "all";

// Fetch RSS via RSSR API
async function fetchRSS(url, sourceName){
  try {
    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${API_KEY}&count=20`);
    const data = await res.json();
    return data.items.map(item=>({
      title:item.title,
      link:item.link,
      pubDate:new Date(item.pubDate),
      source: sourceName
    }));
  } catch(e) {
    console.error("Failed RSS", url, e);
    return [];
  }
}

// Load all stories
async function loadStories(){
  document.getElementById("loading").style.display="block";
  storyData = {};
  displayedCount = {};

  for(let tab in FEEDS){
    displayedCount[tab] = 0;
    const promises = FEEDS[tab].map(feed => fetchRSS(feed.url, feed.name));
    const results = await Promise.all(promises);
    storyData[tab] = results.flat().sort((a,b)=>b.pubDate - a.pubDate);
  }

  storyData["all"] = Object.values(storyData).flat().sort((a,b)=>b.pubDate - a.pubDate);
  displayedCount["all"] = 0;

  renderTab(currentTab);
  document.getElementById("loading").style.display="none";
}

// Render tab content
function renderTab(tab){
  currentTab = tab;
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add("active");

  const container = document.getElementById("content");
  container.innerHTML = "";

  if(tab==="markets"){
    loadMarkets(container);
    return;
  }

  const stories = storyData[tab] || [];
  const loadMoreCount = 12;
  const toDisplay = stories.slice(displayedCount[tab], displayedCount[tab]+loadMoreCount);
  displayedCount[tab] += toDisplay.length;

  if(tab==="all"){
    const grouped = {};
    toDisplay.forEach(story=>{
      if(!grouped[story.source]) grouped[story.source]=[];
      grouped[story.source].push(story);
    });
    for(let source in grouped){
      const heading = document.createElement("div");
      heading.className="feed-heading";
      heading.textContent=source;
      container.appendChild(heading);
      grouped[source].forEach(s=>container.appendChild(createCard(s)));
    }
  } else {
    toDisplay.forEach(s=>container.appendChild(createCard(s)));
  }
}

// Create story card
function createCard(story){
  const card = document.createElement("div");
  card.className="card";
  card.innerHTML = `<a href="${story.link}" target="_blank">${story.title}</a> <span class="source-badge">${story.source}</span>`;
  return card;
}

// Load market numeric cards
async function loadMarkets(container){
  const symbols = ["^GSPC","^DJI","^IXIC","^TSX"];
  for(const s of symbols){
    try{
      const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${s}`);
      const data = await res.json();
      const q = data.quoteResponse.result[0];
      const card = document.createElement("div");
      card.className="card market-card";
      card.style.fontSize="0.9rem";
      card.innerHTML=`${q.shortName || s}<br>Price: ${q.regularMarketPrice}<br>Change: ${q.regularMarketChange.toFixed(2)} (${q.regularMarketChangePercent.toFixed(2)}%)`;
      container.appendChild(card);
    } catch(e){
      console.error(e);
    }
  }

  // Optionally: fetch market news
  if(FEEDS.markets.length>0){
    const promises = FEEDS.markets.map(feed => fetchRSS(feed.url, feed.name));
    const results = await Promise.all(promises);
    results.flat().sort((a,b)=>b.pubDate-a.pubDate).forEach(s=>container.appendChild(createCard(s)));
  }
}

// Tab button listeners
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>renderTab(btn.dataset.tab));
});

// Infinite scroll
window.addEventListener("scroll", ()=>{
  if(window.innerHeight+window.scrollY >= document.body.offsetHeight-100){
    renderTab(currentTab);
  }
});

// Initialize
loadStories();
</script>
</body>
</html>
