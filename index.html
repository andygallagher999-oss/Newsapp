<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Lens</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
header{text-align:center;padding:1rem;background:#2c3e50;color:white;font-size:1.5rem;}
.tab-bar,.category-bar{display:flex;flex-wrap:wrap;justify-content:center;}
.tab-bar{background:#34495e;padding:0.5rem;}
.category-bar{background:#bdc3c7;padding:0.5rem;}
.tab-bar button,.category-bar button{
  margin:0.2rem;padding:0.5rem 1rem;border:none;border-radius:5px;
  background:#ecf0f1;cursor:pointer;transition:background 0.2s;
}
.tab-bar button.active{background:#e67e22;color:white;}
.category-bar button.active{background:#e74c3c;color:white;}
#content{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:1rem;padding:1rem;}
.card{
  background:white;border-radius:10px;padding:1rem;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;flex-direction:column;justify-content:space-between;
  height:350px;overflow:hidden;
}
.card img{width:100%;height:160px;object-fit:cover;border-radius:5px;margin-bottom:0.5rem;}
.card .title{font-weight:bold;margin-bottom:0.5rem;}
.card .source{font-size:0.8rem;color:#7f8c8d;margin-bottom:0.25rem;}
.card .pubdate{font-size:0.8rem;color:#95a5a6;margin-bottom:0.5rem;}
.card .summary{flex:1;margin-bottom:0.5rem;overflow:hidden;
  display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;}
.card.expanded .summary{-webkit-line-clamp:unset;overflow:auto;}
.card .links{display:flex;justify-content:space-between;align-items:center;}
.card .links a{color:#2980b9;text-decoration:none;font-size:0.9rem;}
.card button.read-more{
  background:none;border:none;color:#e67e22;cursor:pointer;
  font-size:0.9rem;padding:0;
}
#backToTop{
  position:fixed;bottom:20px;right:20px;background:#e67e22;color:white;
  border:none;border-radius:50%;width:50px;height:50px;
  font-size:1.5rem;cursor:pointer;display:none;
}
@media (max-width:768px){#content{grid-template-columns:1fr;}}
@media (min-width:769px) and (max-width:1024px){#content{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<header>Global Lens</header>
<div class="tab-bar" id="sourceTabs"></div>
<div class="category-bar" id="categoryTabs"></div>

<div id="content"></div>
<button id="backToTop">â†‘</button>

<script>
const RSS2JSON_API = 'tv1jlyo8aydiiehkz19nesknmhi2xk1gx0kaw23j';
const FINNHUB_API = 'd32q9dhr01qtm6316bk0d32q9dhr01qtm6316bkg';
const PLACEHOLDER = 'assets/images/global-lens-logo.png';

const sources = {
  'All': [],
  'The Guardian': ['https://www.theguardian.com/world/rss'],
  'Billboard': ['https://www.billboard.com/feed/'],
  'TechCrunch': ['https://techcrunch.com/feed/'],
  'CNBC': ['https://www.cnbc.com/id/100003114/device/rss/rss.html'],
  'Bloomberg': ['https://feeds.bloomberg.com/markets/news.rss'],
  'Markets': []
};
const categories = ['World','Business','Technology','Science','Health','Sports','Culture'];

let activeSource = 'All';
let activeCategory = '';
let allArticles = {};

// Build tabs
const sourceTabs = document.getElementById('sourceTabs');
for(const s in sources){
  const btn = document.createElement('button');
  btn.textContent = s;
  btn.onclick = ()=>{ activeSource=s; activeCategory=''; render(); };
  if(s==='All') btn.classList.add('active');
  sourceTabs.appendChild(btn);
}
const categoryTabs = document.getElementById('categoryTabs');
categories.forEach(cat=>{
  const btn=document.createElement('button');
  btn.textContent=cat;
  btn.onclick=()=>{ activeCategory=activeCategory===cat?'':cat; render(); };
  categoryTabs.appendChild(btn);
});

const backToTop=document.getElementById('backToTop');
backToTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
window.onscroll=()=>{backToTop.style.display=window.scrollY>300?'block':'none';};

async function fetchRSS(url){
  try{
    const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=${RSS2JSON_API}&count=30`);
    const data=await res.json();
    if(!data.items) return [];
    return data.items.map(i=>({
      ...i,
      source:data.feed.title,
      description:i.content||i.description||''
    }));
  }catch(e){console.error('RSS Error',url,e);return[];}
}

async function fetchMarkets(){
  try{
    const res=await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_API}`);
    const data=await res.json();
    allArticles['Markets']=data.map(d=>({
      title:d.headline,
      link:d.url,
      pubDate:d.datetime*1000,
      description:d.summary,
      enclosure:{link:d.image},
      source:'Finnhub'
    }));
  }catch(e){console.error('Finnhub error',e);}
}

async function fetchAll(){
  for(const src in sources){
    allArticles[src]=[];
    for(const feed of sources[src]){
      const items=await fetchRSS(feed);
      allArticles[src]=allArticles[src].concat(items);
    }
  }
  await fetchMarkets();
}

function filterArticles(){
  let articles = activeSource==='All'?Object.values(allArticles).flat():allArticles[activeSource]||[];
  if(activeCategory){
    articles = articles.filter(a=>{
      const text=(a.title+' '+(a.description||'')).toLowerCase();
      return text.includes(activeCategory.toLowerCase());
    });
  }
  return articles.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
}

function render(){
  Array.from(sourceTabs.children).forEach(b=>b.classList.toggle('active',b.textContent===activeSource));
  Array.from(categoryTabs.children).forEach(b=>b.classList.toggle('active',b.textContent===activeCategory));
  const container=document.getElementById('content');
  container.innerHTML='';
  filterArticles().forEach(a=>{
    const card=document.createElement('div');
    card.className='card';

    const img=document.createElement('img');
    img.src=(a.enclosure && a.enclosure.link)?a.enclosure.link:PLACEHOLDER;
    img.onerror=()=>{img.src=PLACEHOLDER;};
    card.appendChild(img);

    const title=document.createElement('div');
    title.className='title'; title.textContent=a.title; card.appendChild(title);

    const srcDiv=document.createElement('div');
    srcDiv.className='source'; srcDiv.textContent=a.source||activeSource; card.appendChild(srcDiv);

    const pub=document.createElement('div');
    pub.className='pubdate';
    pub.textContent=a.pubDate?new Date(a.pubDate).toLocaleString():'';
    card.appendChild(pub);

    const summary=document.createElement('div');
    summary.className='summary';
    summary.innerHTML=a.description;
    card.appendChild(summary);

    const links=document.createElement('div');
    links.className='links';
    const readLink=document.createElement('a');
    readLink.href=a.link; readLink.target='_blank'; readLink.textContent='Read full article';
    links.appendChild(readLink);

    if(summary.scrollHeight > summary.clientHeight){
      const btn=document.createElement('button');
      btn.className='read-more';
      btn.textContent='Read More';
      btn.onclick=()=>{
        card.classList.toggle('expanded');
        btn.textContent=card.classList.contains('expanded')?'Read Less':'Read More';
      };
      links.appendChild(btn);
    }
    card.appendChild(links);
    container.appendChild(card);
  });
}

(async()=>{await fetchAll();render();})();
</script>
</body>
</html>
