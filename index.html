<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Lens</title>
<style>
  body { font-family: Arial,sans-serif; margin:0; background:#f5f5f5; }
  header { background:#222; color:#fff; padding:10px; text-align:center; font-size:1.4em; }
  #categoryTabs { display:flex; overflow-x:auto; background:#333; }
  #categoryTabs button {
    flex:1; padding:10px; border:none; background:#333; color:#fff; font-size:1em;
    cursor:pointer; white-space:nowrap; outline:none;
  }
  #categoryTabs button.active { background:#555; }
  #content { padding:10px; max-width:900px; margin:auto; }
  .card {
    display:flex; background:#fff; margin-bottom:10px;
    border-radius:6px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,.1);
  }
  .card img {
    width:100px; height:100px; object-fit:cover; flex-shrink:0;
  }
  .info { padding:10px; flex:1; display:flex; flex-direction:column; }
  .title {
    font-weight:bold; margin-bottom:5px; cursor:pointer;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
  .summary {
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    margin-bottom:5px; font-size:0.9em; color:#333;
  }
  .source { color:#666; font-size:0.85em; }
  .date { color:#999; font-size:0.8em; margin-bottom:6px; }
  #loadingSpinner { text-align:center; padding:15px; display:none; color:#555; }
  .end-message { 
    text-align:center; padding:20px; color:#666; font-style:italic; display:none;
  }
  #loadMoreBtn {
    display:none; 
    margin:15px auto; 
    padding:10px 20px; 
    font-size:1em; 
    background:#333; 
    color:#fff; 
    border:none; 
    border-radius:5px; 
    cursor:pointer;
  }
  #backToTop {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 999;
    display: none;
    background: #333;
    color: #fff;
    border: none;
    padding: 13px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(50,50,50,0.15);
    opacity: 0;
    transition: opacity 0.3s;
  }
  #backToTop.show {
    display: block;
    opacity: 1;
  }
  #backToTop:hover { background: #555; }
</style>
</head>
<body>
<header>Global Lens</header>
<div id="categoryTabs"></div>
<div id="content"></div>
<div id="loadingSpinner">Loading…</div>
<div class="end-message" id="endMessage">No more articles to load</div>
<button id="loadMoreBtn">Load More</button>
<button id="backToTop" title="Back to top">↑</button>

<script>
const API_KEY = "mfvxyevwnjlcnuwmiyprrivbbpyylyhwwzuezdaq";
const BATCH_SIZE = 8;
const PLACEHOLDER = "logo.png";

// Mix of direct RSS and rss2json feeds
const categories = {
  Sports:[
    {url:"https://feeds.skysports.com/feeds/rss/football.xml", direct:true},
    {url:"https://feeds.bbci.co.uk/sport/rss.xml", direct:true},
    {url:"https://rss.cnn.com/rss/edition_sport.rss", direct:true},
    {url:"https://www.sportsnet.ca/feed/", direct:false},
    {url:"https://www.espn.com/espn/rss/news", direct:false},
    {url:"https://www.tsn.ca/rss", direct:false},
    {url:"https://www.bbc.com/sport/football/rss.xml", direct:true},
    {url:"https://globalnews.ca/sports/feed/", direct:false},
    {url:"https://www.cbc.ca/cmlink/rss-sports", direct:true},
    {url:"https://www.skysports.com/rss/12040", direct:true}
  ],
  Business:[
    {url:"https://feeds.reuters.com/reuters/businessNews", direct:true},
    {url:"https://feeds.bbci.co.uk/news/business/rss.xml", direct:true},
    {url:"https://rss.cnn.com/rss/money_latest.rss", direct:true},
    {url:"https://www.marketwatch.com/rss/topstories", direct:false},
    {url:"https://www.investing.com/rss/news.rss", direct:false},
    {url:"https://www.cbc.ca/cmlink/rss-business", direct:true},
    {url:"https://globalnews.ca/business/feed/", direct:false},
    {url:"https://www.bnnbloomberg.ca/rss", direct:false},
    {url:"https://www.financialpost.com/feed", direct:false},
    {url:"https://www.reuters.com/finance/rss", direct:false}
  ],
  News:[
    {url:"https://feeds.bbci.co.uk/news/rss.xml", direct:true},
    {url:"https://rss.cnn.com/rss/edition.rss", direct:true},
    {url:"https://feeds.reuters.com/reuters/topNews", direct:true},
    {url:"https://feeds.npr.org/1001/rss.xml", direct:true},
    {url:"https://feeds.nbcnews.com/nbcnews/public/news", direct:false},
    {url:"https://globalnews.ca/feed/", direct:false},
    {url:"https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009", direct:true},
    {url:"https://www.cbc.ca/cmlink/rss-topstories", direct:true},
    {url:"https://www.cbc.ca/cmlink/rss-canada", direct:true},
    {url:"https://www.theglobeandmail.com/canada/?service=rss", direct:false} // optional placeholder
  ],
  Entertainment:[
    {url:"https://feeds.eonline.com/eonline/news", direct:true},
    {url:"https://feeds.feedburner.com/people/headlines", direct:true},
    {url:"https://www.tmz.com/rss.xml", direct:false},
    {url:"https://www.usmagazine.com/feed/", direct:false},
    {url:"https://www.justjared.com/feed/", direct:false},
    {url:"https://www.etonline.com/rss/news", direct:false},
    {url:"https://www.rollingstone.com/music/music-news/feed/", direct:false},
    {url:"https://www.billboard.com/feed/", direct:false},
    {url:"https://www.vulture.com/rss/index.xml", direct:false},
    {url:"https://www.hollywoodreporter.com/t/film/feed/", direct:false}
  ]
};

let activeCategory = "Sports";
const allArticles = {}; 
const categoryTabs = document.getElementById("categoryTabs");
const contentDiv   = document.getElementById("content");
const spinner      = document.getElementById("loadingSpinner");
const backToTopBtn = document.getElementById("backToTop");
const endMessage   = document.getElementById("endMessage");
const loadMoreBtn  = document.getElementById("loadMoreBtn");

// --- Build category buttons ---
Object.keys(categories).forEach(cat=>{
  const btn = document.createElement("button");
  btn.textContent = cat;
  btn.onclick = ()=>setActiveCategory(cat);
  if(cat===activeCategory) btn.classList.add("active");
  categoryTabs.appendChild(btn);
});

// --- Back-to-top button ---
backToTopBtn.onclick = ()=>window.scrollTo({top:0, behavior:"smooth"});

// --- Scroll handling ---
let scrollTimeout = null;
window.addEventListener("scroll", ()=>{
  if(window.scrollY>120) backToTopBtn.classList.add("show");
  else backToTopBtn.classList.remove("show");

  if(scrollTimeout) clearTimeout(scrollTimeout);
  scrollTimeout = setTimeout(checkInfiniteScroll,100);
});

// --- Helpers ---
function toET(dateStr){ return new Date(new Date(dateStr).getTime() - 4*60*60*1000); }

function extractImage(item){
  if(item.enclosure && item.enclosure.link) return item.enclosure.link;
  if(item.thumbnail) return item.thumbnail;
  if(item['media:thumbnail'] && item['media:thumbnail'].url) return item['media:thumbnail'].url;
  const contentFields=[item.content,item.description,item.summary,item['content:encoded']];
  for(const field of contentFields){
    if(field && /<img/i.test(field)){
      const tmp=document.createElement("div");
      tmp.innerHTML=field;
      const img=tmp.querySelector("img");
      if(img && img.src && !img.src.includes('data:image')) return img.src;
    }
  }
  return null;
}

async function fetchFeed(feedObj){
  if(feedObj.direct){
    try{
      const response = await fetch(feedObj.url);
      const xmlText = await response.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText,'text/xml');
      const parserError=xmlDoc.querySelector('parsererror');
      if(parserError) return [];
      const items = Array.from(xmlDoc.querySelectorAll('item')).map(item=>{
        return {
          title: item.querySelector('title')?.textContent || '',
          link: item.querySelector('link')?.textContent || '',
          description: item.querySelector('description')?.textContent || '',
          content: item.querySelector('content\\:encoded')?.textContent || item.querySelector('description')?.textContent || '',
          pubDate: item.querySelector('pubDate')?.textContent || '',
          source: xmlDoc.querySelector('channel > title')?.textContent || 'Unknown'
        };
      });
      return items;
    }catch(e){ console.error("Direct RSS error",feedObj.url,e); return []; }
  } else {
    try{
      const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedObj.url)}&api_key=${API_KEY}&count=8`);
      const data = await res.json();
      if(data.status!=="ok") return [];
      return data.items.map(i=>({...i, source:data.feed.title}));
    }catch(e){ console.error("RSS2JSON error",feedObj.url,e); return []; }
  }
}

// --- Initialize category state ---
function initCategory(cat){
  allArticles[cat]={feeds:[],merged:[],shown:0,fetching:false,allFeedsLoaded:false,hasMore:true};
  categories[cat].forEach(f=>allArticles[cat].feeds.push({...f,items:[],loaded:false}));
}

// --- Load feeds for category ---
async function loadCategory(cat){
  spinner.style.display="block";
  endMessage.style.display="none";
  initCategory(cat);
  await fetchNextBatch(cat);
  spinner.style.display="none";
  renderBatch(cat);
}

// --- Fetch next batch of feeds ---
async function fetchNextBatch(cat){
  const state=allArticles[cat];
  const unloaded=state.feeds.filter(f=>!f.loaded).slice(0,2);
  if(unloaded.length===0){ state.allFeedsLoaded=true; return; }
  const promises=unloaded.map(async f=>{
    f.items = (await fetchFeed(f)).map(a=>({...a,imgUrl:extractImage(a)||PLACEHOLDER}));
    f.loaded=true;
  });
  await Promise.all(promises);
  mergeCategory(cat);
}

// --- Merge feeds, remove duplicates, sort ---
function mergeCategory(cat){
  const state=allArticles[cat];
  const seen=new Set();
  state.merged = state.feeds.flatMap(f=>f.items).filter(a=>{
    if(seen.has(a.link)) return false;
    seen.add(a.link); return true;
  }).sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
}

// --- Render batch ---
function renderBatch(cat){
  const state=allArticles[cat];
  if(state.fetching) return;
  state.fetching=true;

  // Load next batch if needed
  if(state.shown>=state.merged.length && !state.allFeedsLoaded){
    fetchNextBatch(cat).then(()=>{state.fetching=false; renderBatch(cat);});
    return;
  }

  const nextBatch=state.merged.slice(state.shown,state.shown+BATCH_SIZE);
  nextBatch.forEach(a=>{
    const card=document.createElement("div"); card.className="card";
    const img=document.createElement("img"); img.src=a.imgUrl; img.onerror=()=>{img.src=PLACEHOLDER;};
    const info=document.createElement("div"); info.className="info";
    const title=document.createElement("div"); title.className="title"; title.textContent=a.title; title.onclick=()=>window.open(a.link,"_blank");
    const summary=document.createElement("div"); summary.className="summary"; summary.innerHTML=(a.description||'').replace(/<img[^>]*>/gi,'');
    const src=document.createElement("div"); src.className="source"; src.textContent=a.source;
    const date=document.createElement("div"); date.className="date"; date.textContent=toET(a.pubDate).toLocaleString();
    info.append(title,summary,src,date); card.append(img,info); contentDiv.appendChild(card);
  });

  state.shown += nextBatch.length;
  state.hasMore=state.shown<state.merged.length || !state.allFeedsLoaded;
  updateEndMessage(cat);
  state.fetching=false;
}

// --- End message and Load More button ---
function updateEndMessage(cat){
  const state=allArticles[cat];
  if(!state.hasMore && state.allFeedsLoaded){ endMessage.style.display="block"; loadMoreBtn.style.display="none"; }
  else{ endMessage.style.display="none"; loadMoreBtn.style.display="block"; }
}

// --- Infinite scroll ---
function checkInfiniteScroll(){ renderBatch(activeCategory); }

// --- Category switch ---
async function setActiveCategory(cat){
  if(activeCategory===cat) return;
  activeCategory=cat; contentDiv.innerHTML=""; endMessage.style.display="none";
  Array.from(categoryTabs.children).forEach(b=>b.classList.toggle("active",b.textContent===cat));
  if(!allArticles[cat]) await loadCategory(cat);
  else{ allArticles[cat].shown=0; renderBatch(cat); }
}

// --- Load More button ---
loadMoreBtn.onclick=()=>renderBatch(activeCategory);

// --- Initialize ---
(async()=>{ await loadCategory(activeCategory); })();
</script>
</body>
</html>
